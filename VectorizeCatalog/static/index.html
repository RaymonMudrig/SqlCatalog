<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SQL Catalog QA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Basic styles -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { font-weight: 600; margin-bottom: 12px; }
    .bar { display: flex; gap: 8px; align-items: stretch; margin-bottom: 12px; }
    #prompt {
      flex: 1 1 auto; min-height: 80px; padding: 10px 12px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 8px; resize: vertical;
    }
    button {
      flex: 0 0 auto; padding: 10px 14px; font-size: 16px; border: none;
      border-radius: 8px; background: #0b5; color: white; cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: default; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1100px) { .row { grid-template-columns: 1fr; } }
    #answer { padding: 16px; border: 1px solid #eee; border-radius: 10px; }
    /* Diff area */
    #diffwrap { display:none; padding: 0; border: 1px solid #eee; border-radius: 10px; overflow: auto; }
    /* Fallback pre if diff2html fails */
    #diffpre { white-space: pre-wrap; padding: 16px; margin: 0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .meta { color: #666; font-size: 13px; margin: 8px 0 0; }
    /* Clickable entities */
    .clickable-entity {
      cursor: pointer;
      color: #0066cc;
      text-decoration: none;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }
    .clickable-entity:hover {
      background-color: #e6f2ff;
      text-decoration: underline;
    }
  </style>

  <!-- marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>

  <!-- diff2html CSS/JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
  <!-- highlight.js (optional but improves syntax colors in diff) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js/lib/highlight.js"></script>
</head>
<body>
  <h1>SQL Catalog QA</h1>

  <div class="bar">
    <textarea id="prompt" placeholder="Ask anything about the catalog (e.g., compare dbo.DealOrder vs dbo.DealOrder_20May2017)"></textarea>
    <button id="ask">Ask</button>
  </div>

  <div class="row">
    <div id="answer"></div>
    <div id="diffwrap">
      <div id="diff"></div>
      <pre id="diffpre" hidden></pre>
      <div class="meta" id="diffmeta"></div>
    </div>
  </div>

  <script>
    const server = (new URLSearchParams(location.search)).get('server') || 'http://127.0.0.1:8000';

    // Function to make entity names clickable
    function makeEntitiesClickable(element) {
      // Find all <code> elements (markdown backticks render as <code>)
      const codeElements = element.querySelectorAll('code');

      codeElements.forEach(codeEl => {
        const text = codeEl.textContent.trim();

        // Match entity patterns like: dbo.TableName, schema.ProcName, TableName.ColumnName, etc.
        // Also match qualified columns like dbo.Table.Column
        // Allow spaces within names (e.g., "dbo.BO Client Cash")
        const entityPattern = /^([a-zA-Z_][\w\s]*\.)?[a-zA-Z_][\w\s]*(\.[a-zA-Z_][\w\s]*)?$/;

        if (entityPattern.test(text)) {
          // Create a clickable span
          const span = document.createElement('span');
          span.className = 'clickable-entity';
          span.textContent = text;
          span.title = `Click to add "${text}" to prompt`;

          span.addEventListener('click', (e) => {
            e.preventDefault();
            const promptInput = document.getElementById('prompt');
            const currentValue = promptInput.value.trim();

            // Wrap entity in backticks to avoid ambiguity with spaces
            const wrappedText = '`' + text + '`';

            // Append entity to prompt with a space if needed
            if (currentValue) {
              promptInput.value = currentValue + ' ' + wrappedText;
            } else {
              promptInput.value = wrappedText;
            }

            // Focus the prompt input
            promptInput.focus();

            // Move cursor to end
            promptInput.setSelectionRange(promptInput.value.length, promptInput.value.length);
          });

          // Replace the code element's content with our clickable span
          codeEl.innerHTML = '';
          codeEl.appendChild(span);
        }
      });
    }

    async function ask() {
      const btn = document.getElementById('ask');
      const prompt = document.getElementById('prompt').value.trim();
      const answerEl = document.getElementById('answer');
      const diffWrap = document.getElementById('diffwrap');
      const diffEl = document.getElementById('diff');
      const diffPre = document.getElementById('diffpre');
      const diffMeta = document.getElementById('diffmeta');

      if (!prompt) return;

      btn.disabled = true;
      answerEl.innerHTML = 'Thinkingâ€¦';
      diffWrap.style.display = 'none';
      diffEl.innerHTML = '';
      diffPre.hidden = true;
      diffPre.textContent = '';
      diffMeta.textContent = '';

      try {
        const res = await fetch(`${server}/api/ask`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();

        // Render markdown "answer"
        const md = (data && data.answer) ? data.answer : '(no answer)';
        answerEl.innerHTML = marked.parse(md);

        // Make entity names clickable
        makeEntitiesClickable(answerEl);

        // If unified_diff is present, render a nice side-by-side diff
        if (data && data.unified_diff) {
          diffWrap.style.display = 'block';
          try {
            const diffHtml = Diff2Html.html(data.unified_diff, {
              drawFileList: true,
              outputFormat: 'side-by-side',   // or 'line-by-line'
              matching: 'words',
              highlight: true
            });
            diffEl.innerHTML = diffHtml;
            diffPre.hidden = true;
            diffMeta.textContent = 'Rendered by diff2html';
            // Optionally highlight SQL blocks inside the diff
            document.querySelectorAll('#diff code').forEach(el => { try { hljs.highlightElement(el); } catch {} });
          } catch (e) {
            // Fallback: show raw unified diff in <pre>
            diffEl.innerHTML = '';
            diffPre.hidden = false;
            diffPre.textContent = data.unified_diff;
            diffMeta.textContent = 'Raw unified diff (diff2html failed)';
          }
        }

      } catch (e) {
        answerEl.innerHTML = `<span style="color:#b00">Error: ${e}</span>`;
        diffWrap.style.display = 'none';
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById('ask').addEventListener('click', ask);
    document.getElementById('prompt').addEventListener('keydown', (ev) => {
      if ((ev.ctrlKey || ev.metaKey) && ev.key === 'Enter') ask();
    });
  </script>
</body>
</html>
